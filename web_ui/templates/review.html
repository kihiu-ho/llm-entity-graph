<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity & Relationship Review - Knowledge Graph</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/review.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-project-diagram me-2"></i>Knowledge Graph
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link active" href="{{ url_for('review_dashboard') }}">
                    <i class="fas fa-clipboard-check me-1"></i>Review
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-clipboard-check me-2"></i>Entity & Relationship Review</h2>
                    <div>
                        <button class="btn btn-success me-2" onclick="approveAll()">
                            <i class="fas fa-check-double me-1"></i>Approve All
                        </button>
                        <button class="btn btn-danger me-2" onclick="rejectAll()">
                            <i class="fas fa-times-circle me-1"></i>Reject All
                        </button>
                        <button class="btn btn-primary" onclick="ingestApproved()" id="ingestBtn">
                            <i class="fas fa-upload me-1"></i>Ingest Approved
                        </button>
                    </div>
                </div>

                <!-- Session Info -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ session_data.document_title }}</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card bg-info">
                                    <div class="stat-number">{{ session_data.statistics.total_entities }}</div>
                                    <div class="stat-label">Total Entities</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-success">
                                    <div class="stat-number" id="approvedEntities">{{ session_data.statistics.approved_entities }}</div>
                                    <div class="stat-label">Approved Entities</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-info">
                                    <div class="stat-number">{{ session_data.statistics.total_relationships }}</div>
                                    <div class="stat-label">Total Relationships</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-success">
                                    <div class="stat-number" id="approvedRelationships">{{ session_data.statistics.approved_relationships }}</div>
                                    <div class="stat-label">Approved Relationships</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="reviewTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="entities-tab" data-bs-toggle="tab" data-bs-target="#entities" type="button" role="tab">
                            <i class="fas fa-users me-1"></i>Entities ({{ session_data.statistics.total_entities }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="relationships-tab" data-bs-toggle="tab" data-bs-target="#relationships" type="button" role="tab">
                            <i class="fas fa-link me-1"></i>Relationships ({{ session_data.statistics.total_relationships }})
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="reviewTabContent">
                    <!-- Entities Tab -->
                    <div class="tab-pane fade show active" id="entities" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Status</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Attributes</th>
                                        <th>Confidence</th>
                                        <th>Source Text</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entity in session_data.entities %}
                                    <tr id="entity-{{ entity.id }}" class="entity-row" data-status="{{ entity.status }}">
                                        <td>
                                            <span class="badge status-badge status-{{ entity.status }}">
                                                {{ entity.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm entity-name" 
                                                   value="{{ entity.name }}" data-entity-id="{{ entity.id }}">
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm entity-type" data-entity-id="{{ entity.id }}">
                                                <option value="Person" {% if entity.type == 'Person' %}selected{% endif %}>Person</option>
                                                <option value="Company" {% if entity.type == 'Company' %}selected{% endif %}>Company</option>
                                                <option value="Location" {% if entity.type == 'Location' %}selected{% endif %}>Location</option>
                                                <option value="Technology" {% if entity.type == 'Technology' %}selected{% endif %}>Technology</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="entity-attributes">
                                                {% if entity.attributes %}
                                                    {% for key, value in entity.attributes.items() %}
                                                        {% if key not in ['entity_type', 'source_chunk'] and value %}
                                                            <div class="attribute-item">
                                                                <strong>{{ key.replace('_', ' ').title() }}:</strong>
                                                                <input type="text" class="form-control form-control-sm attribute-value"
                                                                       data-entity-id="{{ entity.id }}" data-attribute="{{ key }}"
                                                                       value="{{ value }}" placeholder="Enter {{ key.replace('_', ' ') }}">
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-primary add-attribute" data-entity-id="{{ entity.id }}">
                                                    <i class="fas fa-plus"></i> Add Attribute
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ "%.1f"|format(entity.confidence * 100) }}%</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ entity.source_text[:100] }}{% if entity.source_text|length > 100 %}...{% endif %}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-success" onclick="approveEntity('{{ entity.id }}')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="rejectEntity('{{ entity.id }}')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button class="btn btn-warning" onclick="editEntity('{{ entity.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div class="tab-pane fade" id="relationships" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Status</th>
                                        <th>Source</th>
                                        <th>Relationship</th>
                                        <th>Target</th>
                                        <th>Attributes</th>
                                        <th>Confidence</th>
                                        <th>Source Text</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for relationship in session_data.relationships %}
                                    <tr id="relationship-{{ relationship.id }}" class="relationship-row" data-status="{{ relationship.status }}">
                                        <td>
                                            <span class="badge status-badge status-{{ relationship.status }}">
                                                {{ relationship.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm relationship-source" 
                                                   value="{{ relationship.source }}" data-relationship-id="{{ relationship.id }}">
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm relationship-type" data-relationship-id="{{ relationship.id }}">
                                                <option value="Employment" {% if relationship.type == 'Employment' %}selected{% endif %}>Employment</option>
                                                <option value="Leadership" {% if relationship.type == 'Leadership' %}selected{% endif %}>Leadership</option>
                                                <option value="Investment" {% if relationship.type == 'Investment' %}selected{% endif %}>Investment</option>
                                                <option value="Partnership" {% if relationship.type == 'Partnership' %}selected{% endif %}>Partnership</option>
                                                <option value="Ownership" {% if relationship.type == 'Ownership' %}selected{% endif %}>Ownership</option>
                                                <option value="RELATES_TO" {% if relationship.type == 'RELATES_TO' %}selected{% endif %}>Related To</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm relationship-target"
                                                   value="{{ relationship.target }}" data-relationship-id="{{ relationship.id }}">
                                        </td>
                                        <td>
                                            <div class="relationship-attributes">
                                                {% if relationship.attributes %}
                                                    {% for key, value in relationship.attributes.items() %}
                                                        {% if key not in ['source_chunk', 'extraction_method'] and value %}
                                                            <div class="attribute-item">
                                                                <strong>{{ key.replace('_', ' ').title() }}:</strong>
                                                                <input type="text" class="form-control form-control-sm attribute-value"
                                                                       data-relationship-id="{{ relationship.id }}" data-attribute="{{ key }}"
                                                                       value="{{ value }}" placeholder="Enter {{ key.replace('_', ' ') }}">
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-success add-rel-attribute" data-relationship-id="{{ relationship.id }}">
                                                    <i class="fas fa-plus"></i> Add Attribute
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ "%.1f"|format(relationship.confidence * 100) }}%</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ relationship.source_text[:100] }}{% if relationship.source_text|length > 100 %}...{% endif %}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-success" onclick="approveRelationship('{{ relationship.id }}')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="rejectRelationship('{{ relationship.id }}')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button class="btn btn-warning" onclick="editRelationship('{{ relationship.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sessionId = '{{ session_id }}';
    </script>
    <script src="{{ url_for('static', filename='js/review.js') }}"></script>
</body>
</html>
